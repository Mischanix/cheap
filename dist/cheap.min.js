/**
 * cheap.js - C-like memory layout for javascript
 * version 0.1.0
 * Copyright 2014 Robert Nix
 * MIT License
 */
(function(){var e,t,r,n,a,i,s,u,o,c=[].slice;e={},i=function(e,t,r,n,a){return{typeName:e,pointerDepth:t,memberName:r,offset:a,arrayLength:n,isArray:null!=n}},e._typedefs={},e.typedef=function(t,r){if(t in e)throw new Error("name collides");return e._typedefs[t]=r,e[t]=function(e,r){return"string"==typeof e?i(t,0,e,r):i(t,0,void 0,r,e)}},e.ptr=function(e,t,r){return null==r&&(r=1),i(e,r,t)},e.typedef("uint"),e.typedef("int"),e.typedef("ushort"),e.typedef("short"),e.typedef("uchar"),e.typedef("char"),e.typedef("float"),e.typedef("double"),e.typedef("void"),u=4,s=2,e.set64Bit=function(e){return e?(u=8,s=3):(u=4,s=2)},e._typeNameToId=function(e){switch(e){case"uint":return 0;case"int":return 1;case"ushort":return 2;case"short":return 3;case"uchar":return 4;case"char":return 5;case"float":return 6;case"double":return 7;default:return-1}},e._arrayName=function(e){switch(e){case 0:case"uint":return"ui32";case 1:case"int":return"i32";case 2:case"ushort":return"ui16";case 3:case"short":return"i16";case 4:case"uchar":return"ui8";case 5:case"char":return"i8";case 6:case"float":return"f32";case 7:case"double":return"f64";default:return"ui32"}},e._arrayElSize=function(e){switch(e){case 0:case"uint":case 1:case"int":return 4;case 2:case"ushort":case 3:case"short":return 2;case 4:case"uchar":case 5:case"char":return 1;case 6:case"float":return 4;case 7:case"double":return 8;default:return u}},e._arrayElShift=function(e){switch(e){case 0:case"uint":case 1:case"int":case 6:case"float":return 2;case 2:case"ushort":case 3:case"short":return 1;case 4:case"uchar":case 5:case"char":return 0;case 7:case"double":return 3;default:return s}},e.sizeof=function(e){if("string"!=typeof e)return e.__size;switch(e){case"char":case"uchar":return 1;case"short":case"ushort":return 2;case"int":case"uint":case"float":return 4;case"double":return 8;case"void*":return u;default:return 1}},e.strideof=function(t){return"string"==typeof t?e.sizeof(t):t.__size+t.__align-1&-t.__align},e.alignof=function(t){return"string"==typeof t?e.sizeof(t):t.__align},a=function(t){var r,n,a,i,s,u,c,f,h,_,l,p,y;return f=t.offset,c=t.member,p=t.type,l=t.stride,n=t.align,_=t.size,i="string"==typeof p,y=e._typeNameToId(p),a=e._arrayName(p),u=e._arrayElShift(p),0!==c.pointerDepth||c.isArray?0===c.pointerDepth?i?{get:function(){var e;return e=this.__a+f>>u,function(t){return function(r,n){return null==n?t.__b[a][e+r]:t.__b[a][e+r]=n}}(this)}}:{get:function(){return function(t){return function(r,n){var a;return a=t.__a+f+r*l,null==n?new p.__ctor(t.__b,a):e.memcpy(t.__b,a,n.__b,n.__a,_)}}(this)}}:(r=y,0>r&&(r=p),h=c.pointerDepth,{get:function(){var e;return e=this.__b.ui32[(this.__a+f)/4],new o(e,r,h)},set:function(e){return this.__b.ui32[(this.__a+f)/4]=e.a}}):i?{get:function(){return this.__b[a][this.__a+f>>u]},set:function(e){return this.__b[a][this.__a+f>>u]=e}}:(s="__c_"+c.memberName,{get:function(){var e;return null!=this[s]?this[s]:(e=new p.__ctor(this.__b,this.__a+f),this[s]=e,e)},set:function(t){return e.memcpy(this.__b,this.__a+f,t.__b,t.__a,_)}})},e.struct=function(t){var r,n,i,s,u,o,c,f,h,_,l,p;if(f=function(){return f.__ctor.apply(this,arguments)},f.__size=0,f.__align=1,Array.isArray(t))for(_=0,l=t.length;l>_;_++)i=t[_],h=e._typedefs[i.typeName]||i.typeName,p=h,i.pointerDepth>0&&(p="void*"),o=e.sizeof(p),r=e.alignof(p),c=o+r-1&-r,i.isArray&&(o+=c*(i.arrayLength-1)),f.__size=f.__size+r-1&-r,u=f.__size,f.__size+=o,r>f.__align&&(f.__align=r),f[i.memberName]={offset:u,member:i,type:h,stride:c,align:r,size:o};else for(s in t)i=t[s],h=e._typedefs[i.typeName]||i.typeName,p=h,i.pointerDepth>0&&(p="void*"),i.memberName=s,o=e.sizeof(p),r=e.alignof(p),c=o+r-1&-r,i.isArray&&(o+=c*(i.arrayLength-1)),u=i.offset,n=u+o,n>f.__size&&(f.__size=n),r>f.__align&&(f.__align=r),f[i.memberName]={offset:u,member:i,type:h,stride:c,align:r,size:o};return f.__ctor=function(e,t){return this.__b=e,this.__a=t,this},f.__ctor.prototype=function(){var e,t,r;t={__t:f};for(e in f)r=f[e],"__"!==e.substr(0,2)&&Object.defineProperty(t,e,a(r));return t}(),f.prototype=f.__ctor.prototype,f},e._heapLast=null,n=function(e,t,r,n){var a;return this.a=e,this.l=t,this.e=e+t,this.prev=r,null!=r&&(r.next=this),this.next=n,null!=n&&(n.prev=this),this.buf=a=new ArrayBuffer(t),this.ui32=new Uint32Array(a),this.i32=new Int32Array(a),this.ui16=new Uint16Array(a),this.i16=new Int16Array(a),this.ui8=new Uint8Array(a),this.i8=new Int8Array(a),this.f32=new Float32Array(a),this.f64=new Float64Array(a),this},n.prototype.free=function(){this===e._heapLast&&(e._heapLast=this.prev),null!=this.prev&&(this.prev.next=this.next),null!=this.next&&(this.next.prev=this.prev)},r=65536,t=2147418112,e.malloc=function(a){var i,s,u,o,c,f;if(0>a)throw new Error("invalid allocation size");if(a=a+15&-16,null===e._heapLast){if(a+r>t)throw new Error("invalid allocation size");return e._heapLast=new n(r,a,null,null)}if(u=e._heapLast,a+u.e<=t)return i=u.e,e._heapLast=new n(i,a,u,null);for(s=null;;){if(o=(null!=(f=u.prev)?f.e:void 0)||r,c=u.a-o,c>=a){i=u.a-a,s=new n(i,a,u.prev,u);break}if(u=u.prev,null==u)throw new Error("heap space not available")}return s},e.free=function(n){var a;if("object"==typeof n)return n.free();if(!(r>n||n>=t))for(a=e._heapLast;;){if(null==a)break;if(a.a===n)return a.free();a=a.prev}},e.getBufferAddress=function(t){var r;for("object"==typeof t&&(t=t.a),r=e._heapLast;;){if(null==r)break;if(r.e>t&&r.a<=t)return[r,t-r.a];r=r.prev}return[null,0]},e._getHeapValue=function(t,r){var n,a,i;switch(i=e.getBufferAddress(t),n=i[0],a=i[1],r){case 0:return n.ui32[0|a/4];case 1:return n.i32[0|a/4];case 2:return n.ui16[0|a/2];case 3:return n.i16[0|a/2];case 4:return n.ui8[0|a];case 5:return n.i8[0|a];case 6:return n.f32[0|a/4];case 7:return n.f64[0|a/8];default:return n.ui32[0|a/4]}},e._setHeapValue=function(t,r,n){var a,i,s;switch(s=e.getBufferAddress(t),a=s[0],i=s[1],r){case 0:return a.ui32[0|i/4]=n;case 1:return a.i32[0|i/4]=n;case 2:return a.ui16[0|i/2]=n;case 3:return a.i16[0|i/2]=n;case 4:return a.ui8[0|i]=n;case 5:return a.i8[0|i]=n;case 6:return a.f32[0|i/4]=n;case 7:return a.f64[0|i/8]=n;default:return a.ui32[0|i/4]=n}},e.memcpy=function(t,r,n,a,i){var s,u,o,c;return null==i&&(s=t,u=r,i=n,o=e.getBufferAddress(s),t=o[0],r=o[1],c=e.getBufferAddress(u),n=c[0],a=c[1]),t.ui8.set(n.ui8.subarray(a,a+i),r)},e.copyBuffer=function(t){var r;return r=e.malloc(t.byteLength),r.ui8.set(new Uint8Array(t),0),r},o=function(e,t,r){return this.a=e,this.t=t,this.p=r,this},o.prototype.deref=function(){var t,r,n,a,i,s,f,h,_;return n=arguments[0],h=2<=arguments.length?c.call(arguments,1):[],a=this.p-1,r=this.a,n||(n=0),0===a?"number"==typeof this.t?e._getHeapValue(r+n*e._arrayElSize(this.t),this.t):(_=e.getBufferAddress(r+n*e.sizeof(this.t)),t=_[0],f=_[1],new this.t(t,f)):(s=e._getHeapValue(r+n*u,0),i=new o(s,this.t,a),h.length>0?this.deref.apply(i,h):i)},o.prototype.set=function(t,r){var n,a,i,s,o;if(s=this.p-1,n=this.a,0>s)throw new Error("bad pointer");return 0===s?"number"==typeof this.t?e._setHeapValue(n+t*e._arrayElSize(this.t),this.t,r):(o=e.getBufferAddress(n+t*e.sizeof(this.t)),a=o[0],i=o[1],e.memcpy(a,i,r.__b,r.__a,e.sizeof(this.t))):e._setHeapValue(n+t*u,0,r.a)},o.prototype.cast=function(t){var r,n;return"string"==typeof t?(t=t.split("*"),r=t.length-1,0===r&&(r=this.p),n=e._typeNameToId(t[0]),0>n&&(n=e._typeDefs[t[0]]),new o(this.a,n,r)):new o(this.a,t,this.p)},e.ref=function(e,t){var r,n,a;return null!=e.__t?(a=e.__t,r=e.__a+e.__b.a,n=1,null!=t&&(r+=a[t].offset,n+=a[t].pointerDepth,a=a[t].type),new o(r,a,n)):new o(e.a,"void*",1)},o.prototype.add=function(e){return new o(this.a+e,this.t,this.p)},"object"==typeof module&&"object"==typeof module.exports?module.exports=e:"function"==typeof define&&define.amd?define(["cheap"],function(){return this.cheap=e}):this.cheap=e}).call(this);